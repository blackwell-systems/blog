sequenceDiagram
    participant Producer
    participant Kafka
    participant SchemaReg as Schema Registry
    participant Consumer
    participant DLQ as Dead Letter Queue
    participant DB as Database
    
    Producer->>SchemaReg: Get schema ID
    SchemaReg-->>Producer: Schema ID: 42
    Producer->>Producer: Validate against schema
    Producer->>Kafka: Publish message<br/>(with schema ID in header)
    
    Kafka->>Consumer: Deliver message
    Consumer->>Consumer: Parse JSON
    
    alt Valid message
        Consumer->>DB: Process & store
        Consumer->>Kafka: Commit offset
        DB-->>Consumer: Success
    else Parse error
        Consumer->>DLQ: Send to DLQ<br/>(with error details)
        Consumer->>Kafka: Commit offset<br/>(skip poison message)
    else Processing error
        Consumer->>Consumer: Retry with backoff
        Note over Consumer: Don't commit offset<br/>Kafka will redeliver
    end
