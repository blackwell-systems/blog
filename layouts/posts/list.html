{{ define "main" }}
<div class="posts-page">
  <h1>{{ .Title }}</h1>

  <!-- Tag Filter with Search -->
  <div class="tag-filter">
    <label class="filter-label">
      <span>Filter by tag on this page:</span>
      <input type="text"
             id="tag-search"
             placeholder="Search tags (e.g., 'go', 'shell'...)"
             autocomplete="off">
    </label>

    <div class="tag-buttons-wrapper">
      <button class="tag-filter-btn active" data-tag="all">
        All Posts <span class="count">({{ len .Paginator.Pages }})</span>
      </button>
      {{ $tagCounts := dict }}
      {{ range .Site.RegularPages }}
        {{ range .Params.tags }}
          {{ $count := index $tagCounts . | default 0 }}
          {{ $tagCounts = merge $tagCounts (dict . (add $count 1)) }}
        {{ end }}
      {{ end }}
      {{ range $tag, $count := $tagCounts }}
        <button class="tag-filter-btn" data-tag="{{ $tag | urlize }}" data-count="{{ $count }}">
          {{ $tag }} <span class="count">({{ $count }})</span>
        </button>
      {{ end }}
    </div>

    <div class="filter-stats">
      <span id="visible-count">{{ len .Paginator.Pages }}</span> of {{ .Paginator.TotalNumberOfElements }} total posts (showing page {{ .Paginator.PageNumber }} of {{ .Paginator.TotalPages }})
    </div>
  </div>

  <!-- Posts List -->
  <div class="posts-list">
    {{ range .Paginator.Pages }}
      <article class="post-item" data-tags="{{ delimit .Params.tags "," }}" data-title="{{ .Title | lower }}">
        <h2>
          <a href="{{ .RelPermalink }}">{{ .Title }}</a>
        </h2>
        <div class="post-meta">
          <time datetime="{{ .Date.Format "2006-01-02" }}">
            {{ .Date.Format "January 2, 2006" }}
          </time>
          {{ if .Params.categories }}
            <span class="categories">
              {{ range $index, $cat := .Params.categories }}
                {{ if $index }} · {{ end }}
                <a href="{{ "/categories/" | relLangURL }}{{ $cat | urlize }}">{{ $cat }}</a>
              {{ end }}
            </span>
          {{ end }}
        </div>
        <div class="post-tags">
          {{ range .Params.tags }}
            <span class="tag" data-tag="{{ . | urlize }}">{{ . }}</span>
          {{ end }}
        </div>
        <p class="post-summary">{{ .Summary }}</p>
      </article>
    {{ end }}
  </div>

  <div class="no-posts-message" style="display: none;">
    <p>No posts match the selected tag. <a href="#" onclick="filterPosts('all'); return false;">Show all posts</a></p>
  </div>

  <!-- Pagination -->
  {{ if gt .Paginator.TotalPages 1 }}
  <nav class="pagination">
    {{ if .Paginator.HasPrev }}
      <a href="{{ .Paginator.Prev.URL }}" class="pagination-link prev">← Newer Posts</a>
    {{ end }}
    
    <span class="pagination-info">
      Page {{ .Paginator.PageNumber }} of {{ .Paginator.TotalPages }}
    </span>
    
    {{ if .Paginator.HasNext }}
      <a href="{{ .Paginator.Next.URL }}" class="pagination-link next">Older Posts →</a>
    {{ end }}
  </nav>
  {{ end }}
</div>

<style>
.posts-page {
  max-width: 900px;
  margin: 0 auto;
  padding: 2rem 1rem;
  text-align: left;
}

.posts-page h1,
.posts-page h2,
.posts-page h3,
.posts-page p,
.posts-page article,
.posts-page div {
  text-align: left;
}

.tag-filter {
  margin: 2rem 0;
  padding: 1.5rem;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 8px;
  border-left: 3px solid rgba(100, 200, 255, 0.5);
}

.filter-label {
  display: block;
  margin-bottom: 1rem;
  font-weight: 600;
}

.filter-label span {
  display: block;
  margin-bottom: 0.5rem;
  opacity: 0.8;
}

#tag-search {
  width: 100%;
  max-width: 400px;
  padding: 0.6rem 1rem;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  color: inherit;
  font-size: 100%;
  transition: all 0.2s;
}

#tag-search:focus {
  outline: none;
  background: rgba(255, 255, 255, 0.08);
  border-color: rgba(100, 200, 255, 0.5);
}

.tag-buttons-wrapper {
  margin: 1rem 0;
  max-height: 200px;
  overflow-y: auto;
  padding: 0.5rem;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 4px;
}

.tag-filter-btn {
  margin: 0.25rem;
  padding: 0.4rem 0.9rem;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  color: inherit;
  cursor: pointer;
  font-size: 90%;
  transition: all 0.2s;
  display: inline-block;
}

.tag-filter-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(100, 200, 255, 0.5);
}

.tag-filter-btn.active {
  background: rgba(100, 200, 255, 0.2);
  border-color: rgba(100, 200, 255, 0.8);
  font-weight: 600;
}

.tag-filter-btn.hidden {
  display: none;
}

.tag-filter-btn .count {
  opacity: 0.6;
  font-size: 90%;
  margin-left: 0.25rem;
}

.filter-stats {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  opacity: 0.7;
  font-size: 90%;
}

#visible-count {
  font-weight: 600;
  color: rgba(100, 200, 255, 1);
}

.post-item {
  margin: 2rem 0;
  padding: 1.5rem;
  background: rgba(255, 255, 255, 0.02);
  border-radius: 8px;
  border-left: 3px solid transparent;
  transition: all 0.3s;
}

.post-item:hover {
  background: rgba(255, 255, 255, 0.04);
  border-left-color: rgba(100, 200, 255, 0.5);
}

.post-item h2 {
  margin: 0 0 0.5rem 0;
  font-size: 1.5rem;
}

.post-item h2 a {
  text-decoration: none;
  color: inherit;
}

.post-meta {
  opacity: 0.7;
  font-size: 90%;
  margin-bottom: 0.75rem;
}

.post-meta time {
  margin-right: 1rem;
}

.post-tags {
  margin: 0.75rem 0;
}

.post-tags .tag {
  display: inline-block;
  padding: 0.2rem 0.6rem;
  margin: 0.2rem;
  background: rgba(100, 200, 255, 0.1);
  border-radius: 3px;
  font-size: 85%;
  cursor: pointer;
  transition: background 0.2s;
}

.post-tags .tag:hover {
  background: rgba(100, 200, 255, 0.2);
}

.post-summary {
  opacity: 0.85;
  line-height: 1.6;
}

.no-posts-message {
  text-align: center;
  padding: 3rem;
  opacity: 0.6;
}

.post-item.filtered-out {
  display: none;
}

.pagination {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 3rem 0 2rem;
  padding: 1.5rem;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 8px;
  gap: 1rem;
}

.pagination-link {
  padding: 0.75rem 1.5rem;
  background: rgba(100, 200, 255, 0.1);
  border: 1px solid rgba(100, 200, 255, 0.3);
  border-radius: 4px;
  text-decoration: none;
  color: rgba(100, 200, 255, 1);
  transition: all 0.2s;
  font-weight: 500;
}

.pagination-link:hover {
  background: rgba(100, 200, 255, 0.2);
  border-color: rgba(100, 200, 255, 0.5);
}

.pagination-info {
  opacity: 0.7;
  font-size: 90%;
}

@media (max-width: 600px) {
  .pagination {
    flex-direction: column;
    text-align: center;
  }
}
</style>

<script>
function filterPosts(selectedTag) {
  const posts = document.querySelectorAll('.post-item');
  const buttons = document.querySelectorAll('.tag-filter-btn');
  const noPostsMsg = document.querySelector('.no-posts-message');
  const visibleCountEl = document.getElementById('visible-count');
  let visibleCount = 0;

  // Update button states
  buttons.forEach(btn => {
    if (btn.dataset.tag === selectedTag) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });

  // Filter posts
  posts.forEach(post => {
    const postTags = post.dataset.tags.toLowerCase().split(',');

    if (selectedTag === 'all' || postTags.includes(selectedTag.toLowerCase())) {
      post.classList.remove('filtered-out');
      visibleCount++;
    } else {
      post.classList.add('filtered-out');
    }
  });

  // Update visible count
  visibleCountEl.textContent = visibleCount;

  // Show/hide no posts message
  if (visibleCount === 0) {
    noPostsMsg.style.display = 'block';
  } else {
    noPostsMsg.style.display = 'none';
  }

  // Update URL hash
  if (selectedTag === 'all') {
    history.pushState(null, null, window.location.pathname);
  } else {
    history.pushState(null, null, '#tag-' + selectedTag);
  }
}

function searchTags(query) {
  const buttons = document.querySelectorAll('.tag-filter-btn:not([data-tag="all"])');
  const lowerQuery = query.toLowerCase();

  buttons.forEach(btn => {
    const tagName = btn.textContent.toLowerCase();
    if (lowerQuery === '' || tagName.includes(lowerQuery)) {
      btn.classList.remove('hidden');
    } else {
      btn.classList.add('hidden');
    }
  });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  const tagSearch = document.getElementById('tag-search');

  // Tag search input
  tagSearch.addEventListener('input', function() {
    searchTags(this.value);
  });

  // Click handlers for filter buttons
  document.querySelectorAll('.tag-filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      filterPosts(this.dataset.tag);
      tagSearch.value = '';  // Clear search
      searchTags('');        // Show all tags
    });
  });

  // Click handlers for post tags
  document.querySelectorAll('.post-tags .tag').forEach(tag => {
    tag.addEventListener('click', function() {
      filterPosts(this.dataset.tag);
      window.scrollTo({ top: 0, behavior: 'smooth' });
      tagSearch.value = '';  // Clear search
      searchTags('');        // Show all tags
    });
  });

  // Check URL hash on load
  const hash = window.location.hash;
  if (hash.startsWith('#tag-')) {
    const tag = hash.substring(5);
    filterPosts(tag);
  }

  // Sort tag buttons by count (descending)
  const wrapper = document.querySelector('.tag-buttons-wrapper');
  const allBtn = document.querySelector('[data-tag="all"]');
  const tagButtons = Array.from(document.querySelectorAll('.tag-filter-btn:not([data-tag="all"])'));

  tagButtons.sort((a, b) => {
    const countA = parseInt(a.dataset.count) || 0;
    const countB = parseInt(b.dataset.count) || 0;
    return countB - countA;
  });

  wrapper.innerHTML = '';
  wrapper.appendChild(allBtn);
  tagButtons.forEach(btn => wrapper.appendChild(btn));
});
</script>
{{ end }}
